{% extends "base.html" %}

{% block title %}AI Study Assistant{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">AI Study Assistant</h4>
                    <small>Ask questions about your notes or request study materials</small>
                </div>
                <div class="card-body">
                    <!-- Chat messages container -->
                    <div id="chat-messages" class="mb-3" style="height: 60vh; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px;">
                        <div class="text-center text-muted my-5" id="welcome-message">
                            <i class="fas fa-robot fa-3x mb-3"></i>
                            <h5>Welcome to your AI Study Assistant!</h5>
                            <p>Ask me anything about your notes or request study questions.</p>
                            <div class="suggestions mt-3">
                                <button class="btn btn-outline-primary btn-sm m-1 suggestion-btn">Summarize my notes on...</button>
                                <button class="btn btn-outline-primary btn-sm m-1 suggestion-btn">Create flashcards for...</button>
                                <button class="btn btn-outline-primary btn-sm m-1 suggestion-btn">Explain this concept...</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Message input -->
                    <div class="input-group">
                        <input type="text" id="user-message" class="form-control" placeholder="Type your question here..." autocomplete="off">
                        <button class="btn btn-primary" type="button" id="send-button">
                            <i class="fas fa-paper-plane"></i> Send
                        </button>
                    </div>
                    
                    <!-- Loading indicator -->
                    <div id="loading" class="text-center mt-2" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span class="ms-2">AI is thinking...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chatMessages = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-message');
        const sendButton = document.getElementById('send-button');
        const loadingIndicator = document.getElementById('loading');
        const welcomeMessage = document.getElementById('welcome-message');
        
        // Handle suggestion clicks
        document.querySelectorAll('.suggestion-btn').forEach(button => {
            button.addEventListener('click', function() {
                userInput.value = this.textContent;
                userInput.focus();
            });
        });
        
        // Handle send button click
        sendButton.addEventListener('click', sendMessage);
        
        // Handle Enter key
        userInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;
            
            // Hide welcome message after first message
            if (welcomeMessage) {
                welcomeMessage.style.display = 'none';
            }
            
            // Add user message to chat
            addMessage('user', message);
            userInput.value = '';
            
            // Show loading indicator
            loadingIndicator.style.display = 'block';
            
            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Send message to server
            fetch('/ai/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                addMessage('ai', data.response);
            })
            .catch(error => {
                console.error('Error:', error);
                addMessage('ai', `Sorry, I encountered an error: ${error.message}`);
            })
            .finally(() => {
                loadingIndicator.style.display = 'none';
                chatMessages.scrollTop = chatMessages.scrollHeight;
            });
        }
        
        function addMessage(sender, text) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `mb-3 ${sender}-message`;
            
            const messageBubble = document.createElement('div');
            messageBubble.className = `p-3 rounded-3 ${sender === 'user' ? 'bg-primary text-white ms-auto' : 'bg-light'}`;
            messageBubble.style.maxWidth = '80%';
            messageBubble.style.wordWrap = 'break-word';
            
            // Format the text with line breaks
            const formattedText = text.replace(/\n/g, '<br>');
            messageBubble.innerHTML = formattedText;
            
            // Add icon based on sender
            const icon = document.createElement('i');
            icon.className = sender === 'user' ? 'fas fa-user me-2' : 'fas fa-robot me-2';
            messageBubble.prepend(icon);
            
            messageDiv.appendChild(messageBubble);
            chatMessages.appendChild(messageDiv);
            
            // Scroll to the new message
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    });
</script>
{% endblock %}
